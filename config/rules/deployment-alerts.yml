groups:
  # üöÄ R√®gles d'alerte pour le syst√®me de d√©ploiement
  - name: deployment-system-alerts
    rules:
    
    # üîå Port Manager - Service indisponible
    - alert: PortManagerDown
      expr: up{job="port-manager"} == 0
      for: 1m
      labels:
        severity: critical
        service: port-manager
      annotations:
        summary: "Port Manager est indisponible"
        description: "Le service Port Manager sur le port 3005 ne r√©pond pas depuis {{ $value }} minutes"
        alert_type: "service_down"
        runbook_url: "https://github.com/nekocheik/deployment-monitoring/wiki/Port-Manager-Down"

    # üîå Port Manager - Utilisation √©lev√©e des ports
    - alert: PortManagerHighUtilization
      expr: |
        (
          (900 - on() port_manager_available_ports) / 900 * 100
        ) > 80
      for: 5m
      labels:
        severity: warning
        service: port-manager
      annotations:
        summary: "Utilisation √©lev√©e des ports ({{ $value }}%)"
        description: "Plus de 80% des ports sont allou√©s. Consid√©rez l'expansion de la plage."
        alert_type: "resource_exhaustion"
        value: "{{ $value }}%"

    # üîå Port Manager - √âchecs d'allocation
    - alert: PortManagerAllocationFailures
      expr: increase(port_manager_allocation_failures_total[5m]) > 3
      for: 1m
      labels:
        severity: warning
        service: port-manager
      annotations:
        summary: "√âchecs r√©p√©t√©s d'allocation de ports"
        description: "{{ $value }} √©checs d'allocation dans les 5 derni√®res minutes"
        alert_type: "allocation_failure"

    # üöÄ Deployment API - Service indisponible
    - alert: DeploymentAPIDown
      expr: up{job="deployment-api"} == 0
      for: 1m
      labels:
        severity: critical
        service: deployment-api
      annotations:
        summary: "Deployment API est indisponible"
        description: "Le service Deployment API sur le port 3004 ne r√©pond pas"
        alert_type: "service_down"
        runbook_url: "https://github.com/nekocheik/deployment-monitoring/wiki/Deployment-API-Down"

    # üöÄ Deployment API - √âchecs de d√©ploiement
    - alert: DeploymentFailures
      expr: increase(deployment_failures_total[10m]) > 2
      for: 1m
      labels:
        severity: warning
        service: deployment-api
      annotations:
        summary: "√âchecs r√©p√©t√©s de d√©ploiement"
        description: "{{ $value }} d√©ploiements ont √©chou√© dans les 10 derni√®res minutes"
        alert_type: "deployment_failure"

    # üöÄ Deployment API - Temps de d√©ploiement √©lev√©
    - alert: DeploymentHighLatency
      expr: |
        histogram_quantile(0.95, 
          rate(deployment_duration_seconds_bucket[5m])
        ) > 600
      for: 2m
      labels:
        severity: warning
        service: deployment-api
      annotations:
        summary: "Temps de d√©ploiement √©lev√©"
        description: "95% des d√©ploiements prennent plus de 10 minutes ({{ $value }}s)"
        alert_type: "performance_degradation"
        value: "{{ $value }}s"

    # üå©Ô∏è Tunnel Manager - Service indisponible
    - alert: TunnelManagerDown
      expr: up{job="tunnel-manager"} == 0
      for: 1m
      labels:
        severity: critical
        service: tunnel-manager
      annotations:
        summary: "Tunnel Manager est indisponible"
        description: "Le service Tunnel Manager sur le port 3001 ne r√©pond pas"
        alert_type: "service_down"
        runbook_url: "https://github.com/nekocheik/deployment-monitoring/wiki/Tunnel-Manager-Down"

    # üå©Ô∏è Tunnel Manager - √âchecs de configuration Cloudflare
    - alert: CloudflareConfigurationFailures
      expr: increase(tunnel_manager_cloudflare_failures_total[5m]) > 2
      for: 1m
      labels:
        severity: warning
        service: tunnel-manager
      annotations:
        summary: "√âchecs de configuration Cloudflare"
        description: "{{ $value }} √©checs de configuration Cloudflare dans les 5 derni√®res minutes"
        alert_type: "cloudflare_failure"

    # üóÑÔ∏è MongoDB - Base de donn√©es indisponible
    - alert: MongoDBDown
      expr: up{job="mongodb"} == 0
      for: 1m
      labels:
        severity: critical
        service: mongodb
      annotations:
        summary: "MongoDB est indisponible"
        description: "La base de donn√©es MongoDB ne r√©pond pas"
        alert_type: "database_down"
        runbook_url: "https://github.com/nekocheik/deployment-monitoring/wiki/MongoDB-Down"

    # üóÑÔ∏è MongoDB - Connexions √©lev√©es
    - alert: MongoDBHighConnections
      expr: mongodb_connections{state="current"} > 80
      for: 5m
      labels:
        severity: warning
        service: mongodb
      annotations:
        summary: "Nombre √©lev√© de connexions MongoDB"
        description: "{{ $value }} connexions actives sur MongoDB"
        alert_type: "resource_exhaustion"
        value: "{{ $value }}"

  # üñ•Ô∏è R√®gles d'alerte infrastructure
  - name: infrastructure-alerts
    rules:
    
    # üíæ Espace disque faible
    - alert: DiskSpaceLow
      expr: |
        (
          node_filesystem_avail_bytes{mountpoint="/"} / 
          node_filesystem_size_bytes{mountpoint="/"} * 100
        ) < 10
      for: 1m
      labels:
        severity: critical
        service: system
      annotations:
        summary: "Espace disque critique ({{ $value }}%)"
        description: "Moins de 10% d'espace disque disponible sur /"
        alert_type: "disk_space"
        value: "{{ $value }}%"

    # üß† Utilisation m√©moire √©lev√©e
    - alert: HighMemoryUsage
      expr: |
        (
          1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
        ) * 100 > 90
      for: 5m
      labels:
        severity: warning
        service: system
      annotations:
        summary: "Utilisation m√©moire √©lev√©e ({{ $value }}%)"
        description: "Plus de 90% de la m√©moire est utilis√©e"
        alert_type: "memory_usage"
        value: "{{ $value }}%"

    # ‚ö° Charge CPU √©lev√©e
    - alert: HighCPUUsage
      expr: |
        (
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
        ) > 80
      for: 5m
      labels:
        severity: warning
        service: system
      annotations:
        summary: "Charge CPU √©lev√©e ({{ $value }}%)"
        description: "Utilisation CPU sup√©rieure √† 80% pendant 5 minutes"
        alert_type: "cpu_usage"
        value: "{{ $value }}%"

    # üê≥ Container Docker arr√™t√©
    - alert: ContainerDown
      expr: |
        time() - container_last_seen{name=~".*-deploy"} > 60
      for: 1m
      labels:
        severity: warning
        service_type: deployed-app
      annotations:
        summary: "Container {{ $labels.name }} arr√™t√©"
        description: "Le container {{ $labels.name }} n'est plus visible depuis plus d'une minute"
        alert_type: "container_down"

    # üê≥ Container avec red√©marrages fr√©quents
    - alert: ContainerRestartLoop
      expr: increase(container_spec_restart_policy_always[15m]) > 3
      for: 1m
      labels:
        severity: warning
        service_type: deployed-app
      annotations:
        summary: "Container {{ $labels.name }} red√©marre fr√©quemment"
        description: "{{ $value }} red√©marrages en 15 minutes"
        alert_type: "restart_loop"

  # üåê R√®gles d'alerte applications
  - name: application-alerts
    rules:
    
    # üåê Application non accessible
    - alert: ApplicationDown
      expr: up{job="deployed-apps"} == 0
      for: 2m
      labels:
        severity: warning
        service_type: deployed-app
      annotations:
        summary: "Application sur {{ $labels.instance }} non accessible"
        description: "L'application ne r√©pond pas aux health checks"
        alert_type: "application_down"
        port: "{{ $labels.port }}"

    # üåê Temps de r√©ponse √©lev√©
    - alert: ApplicationHighLatency
      expr: |
        histogram_quantile(0.95, 
          rate(http_request_duration_seconds_bucket{job="deployed-apps"}[5m])
        ) > 5
      for: 5m
      labels:
        severity: warning
        service_type: deployed-app
      annotations:
        summary: "Temps de r√©ponse √©lev√© pour {{ $labels.instance }}"
        description: "95% des requ√™tes prennent plus de 5 secondes"
        alert_type: "performance_degradation"
        value: "{{ $value }}s"

    # üåê Taux d'erreur √©lev√©
    - alert: ApplicationHighErrorRate
      expr: |
        (
          sum(rate(http_requests_total{job="deployed-apps",status=~"5.."}[5m])) by (instance) /
          sum(rate(http_requests_total{job="deployed-apps"}[5m])) by (instance)
        ) * 100 > 10
      for: 2m
      labels:
        severity: warning
        service_type: deployed-app
      annotations:
        summary: "Taux d'erreur √©lev√© pour {{ $labels.instance }}"
        description: "{{ $value }}% d'erreurs HTTP 5xx"
        alert_type: "error_rate"
        value: "{{ $value }}%"