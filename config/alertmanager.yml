global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'monitoring@silverhawk77.click'
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# üìã Templates pour les notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# üîÑ Route des alertes
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'deployment-team'
  routes:
  # Alertes critiques - notification imm√©diate
  - match:
      severity: critical
    receiver: 'critical-alerts'
    group_wait: 10s
    repeat_interval: 30m
    
  # Alertes de d√©ploiement
  - match:
      service: deployment-api
    receiver: 'deployment-alerts'
    group_interval: 5m
    
  # Alertes infrastructure
  - match_re:
      service: port-manager|tunnel-manager|mongodb
    receiver: 'infrastructure-alerts'
    
  # Alertes applications
  - match:
      service_type: deployed-app
    receiver: 'application-alerts'

# üì¨ R√©cepteurs de notifications
receivers:
# √âquipe de d√©ploiement par d√©faut
- name: 'deployment-team'
  slack_configs:
  - api_url: '${SLACK_WEBHOOK_URL}'
    channel: '#deployment-monitoring'
    title: 'üîî Alerte D√©ploiement'
    text: |
      *Alerte:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
      *S√©v√©rit√©:* {{ .GroupLabels.severity }}
      *Service:* {{ .GroupLabels.service }}
      *Instance:* {{ .GroupLabels.instance }}
      
      {{ range .Alerts }}
      *Description:* {{ .Annotations.description }}
      *Liens:* [Grafana Dashboard](https://grafana.silverhawk77.click) | [Prometheus](https://prometheus.silverhawk77.click)
      {{ end }}
    send_resolved: true

# Alertes critiques
- name: 'critical-alerts'
  slack_configs:
  - api_url: '${SLACK_WEBHOOK_URL}'
    channel: '#alerts-critical'
    title: 'üö® ALERTE CRITIQUE - Action Imm√©diate Requise'
    text: |
      üö® *ALERTE CRITIQUE* üö®
      
      *Service:* {{ .GroupLabels.service }}
      *Instance:* {{ .GroupLabels.instance }}
      
      {{ range .Alerts }}
      *Probl√®me:* {{ .Annotations.summary }}
      *D√©tails:* {{ .Annotations.description }}
      *Valeur:* {{ .Annotations.value }}
      {{ end }}
      
      *Actions sugg√©r√©es:*
      - V√©rifier l'√©tat du service
      - Consulter les logs d√©taill√©s
      - Escalader si n√©cessaire
      
      *Liens utiles:*
      [üîç Grafana](https://grafana.silverhawk77.click) | [üìä Prometheus](https://prometheus.silverhawk77.click) | [üîî Alertmanager](https://alerts.silverhawk77.click)
    send_resolved: true
    
  # Email pour alertes critiques
  email_configs:
  - to: 'admin@silverhawk77.click'
    subject: 'üö® ALERTE CRITIQUE - {{ .GroupLabels.service }}'
    body: |
      Service en panne critique d√©tect√©:
      
      Service: {{ .GroupLabels.service }}
      Instance: {{ .GroupLabels.instance }}
      
      {{ range .Alerts }}
      Probl√®me: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      Heure: {{ .StartsAt }}
      {{ end }}
      
      V√©rifiez imm√©diatement l'infrastructure.

# Alertes de d√©ploiement
- name: 'deployment-alerts'
  slack_configs:
  - api_url: '${SLACK_WEBHOOK_URL}'
    channel: '#deployments'
    title: 'üöÄ Alerte D√©ploiement'
    text: |
      *Statut D√©ploiement:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
      
      {{ range .Alerts }}
      *Service:* {{ .Labels.service }}
      *Type:* {{ .Annotations.alert_type }}
      *D√©tails:* {{ .Annotations.description }}
      {{ if .Annotations.deployment_id }}*ID D√©ploiement:* {{ .Annotations.deployment_id }}{{ end }}
      {{ if .Annotations.project }}*Projet:* {{ .Annotations.project }}{{ end }}
      {{ if .Annotations.branch }}*Branche:* {{ .Annotations.branch }}{{ end }}
      {{ end }}

# Alertes infrastructure
- name: 'infrastructure-alerts'
  slack_configs:
  - api_url: '${SLACK_WEBHOOK_URL}'
    channel: '#infrastructure'
    title: 'üèóÔ∏è Alerte Infrastructure'
    text: |
      *Infrastructure:* {{ .GroupLabels.service }}
      
      {{ range .Alerts }}
      *Probl√®me:* {{ .Annotations.summary }}
      *Description:* {{ .Annotations.description }}
      {{ if .Annotations.value }}*Valeur actuelle:* {{ .Annotations.value }}{{ end }}
      {{ end }}

# Alertes applications d√©ploy√©es
- name: 'application-alerts'
  slack_configs:
  - api_url: '${SLACK_WEBHOOK_URL}'
    channel: '#applications'
    title: 'üåê Alerte Application'
    text: |
      *Application:* {{ .GroupLabels.instance }}
      
      {{ range .Alerts }}
      *Statut:* {{ .Annotations.summary }}
      *D√©tails:* {{ .Annotations.description }}
      {{ if .Annotations.url }}*URL:* {{ .Annotations.url }}{{ end }}
      {{ if .Annotations.port }}*Port:* {{ .Annotations.port }}{{ end }}
      {{ end }}

# Configuration d'inhibition des alertes
inhibit_rules:
# Inhiber les alertes warning si critical est active
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  equal: ['alertname', 'service', 'instance']

# Inhiber les alertes d'application si le service de d√©ploiement est down
- source_match:
    service: 'deployment-api'
    severity: 'critical'
  target_match:
    service_type: 'deployed-app'
  equal: ['instance']